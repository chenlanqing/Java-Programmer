书籍：
- [《深入理解计算机系统-3》网络资料](https://csapp.cs.cmu.edu/)
- [《深入理解计算机系统(CSAPP)》电子书](https://hansimov.gitbook.io/csapp)
- [《深入理解计算机系统-3》思维导图](https://blog.csdn.net/qq_40680007/article/details/112869312)

# 一、计算机系统基础

## 1、编译系统

如下C语言代码：
```c
#include<stdio.h>
int main(){
  printf("Hello world\n");
  return 0;
}
```
在Linux上执行编译过程时：
```bash
$ gcc -o hello hello.c
```
gcc编译器读取hello.c源文件，将其翻译为一个可执行文件hello，这个过程可以分为4个阶段：执行这四个阶段的程序（预处理器、编译器、汇编器和链接器）一起构成了编译系统

![](image/C程序编译过程.png)
- 预处理阶段：预处理器（CPP)根据以字符 #开头的命令，修改原始的 C 程序。比如hello.c 中第 1 行的`#include < stdio.h>` 命令告诉预处理器读取系统头文件`stdio.h` 的内容，并把它直接插入程序文本中。结果就得到了另一个 C 程序，通常是以`.i` 作为文件扩展名；
- 编译阶段：编译器(ccl)将文本文件 `hello.i` 翻译成文本文件 `hello.s`，它包含一个汇编语言程序。该程序包含函数 main 的定义，如下所示：
  ```
  1   main:
  2     subbq  $8, %rsp
  3     movl   $.LCO, %edi
  4     call   puts
  5     movl   $0, %eax
  6     addq   $8, %rsp
  7     ret
  ```
  定义中 2〜7 行的每条语句都以一种文本格式描述了一条低级机器语言指令
- 汇编阶段：汇编器(as)将 `hello.s` 翻译成机器语言指令，把这些指令打包成一种叫做可重定位目标程序（relocatable object program)的格式，并将结果保存在目标文件 hello.o 中。hello.o 文件是一个二进制文件，它包含的 17 个字节是函数 main的指令编码。如果在文本编辑器中打开 hello.o 文件，将看到一堆乱码；
- 链接阶段：请注意，hello 程序调用了 printf 函数，它是每个 C 编译器都提供的标准 C 库中的一个函数。printf 函数存在于一个名为 printf.o 的单独的预编译好了的目标文件中，而这个文件必须以某种方式合并到我们的 hello.o 程序中。链接器(Id)就负责处理这种合并。结果就得到 hello 文件，它是一个可执行目标文件(或者简称为可执行文件），可以被加载到内存中，由系统执行。

## 2、系统硬件组成

一个典型系统的硬件组织：

![](image/典型的硬件组织.png)

- **总线**：贯穿整个系统的是一组电子管道，称作总线，它携带信息字节并负责在各个部件间传递。通常总线被设计成传送定长的字节块，也就是字（word）。字中的字节数（即字长）是一个基本的系统参数；
- **I/O 设备**：I/O设备是系统与外部世界的联系通道，每个 I/O 设备都通过一个控制器或适配器与 I/O 总线相连。控制器和适配器之间的区别主要在于它们的封装方式。
    - 控制器是 I/O 设备本身或者系统的主印制电路板（通常称作主板）上的芯片组。
    - 适配器则是一块插在主板插槽上的卡。<br/>
    无论如何，它们的功能都是在 I/O 总线和 I/O 设备之间传递信息
- **主存**：主存是一个临时存储设备，在处理器执行程序时，用来存放程序和程序处理的数据。从物理上来说，主存是由一组动态随机存取存储器（DRAM）芯片组成的
- **处理器**：中央处理单元（CPU），简称处理器，是解释（或执行）存储在主存中指令的引擎。处理器的核心是一个大小为一个字的存储设备（或寄存器），称为程序计数器（PC）。在任何时刻，PC 都指向主存中的某条机器语言指令（即含有该条指令的地址），从系统通电开始，直到系统断电，处理器一直在不断地执行程序计数器指向的指令，再更新程序计数器，使其指向下一条指令；它们围绕着主存、寄存器文件（register file）和算术/逻辑单元（ALU）进行

寄存器文件是一个小的存储设备，由一些单个字长的寄存器组成，每个寄存器都有唯一的名字。ALU 计算新的数据和地址值。下面是一些简单操作的例子，CPU 在指令的要求下可能会执行这些操作。
- 加载：从主存复制一个字节或者一个字到寄存器，以覆盖寄存器原来的内容。
- 存储：从寄存器复制一个字节或者一个字到主存的某个位置，以覆盖这个位置上原 来的内容。 
- 操作：把两个寄存器的内容复制到 ALU，ALU 对这两个字做算术运算，并将结果存放到一个寄存器中，以覆盖该寄存器中原来的内容。 
- 跳转：从指令本身中抽取一个字，并将这个字复制到程序计数器（PC）中，以覆盖 PC 中原来的值

## 3、存储设备层次结构

每个计算机系统中的存储设备都被组织成了一个存储器层次结构，在这个层次结构中，从上至下，设备的访问速度越来越慢、容量越来越大，并且每字节的造价也越来越便宜。寄存器文件在层次结构中位于最顶部，也就是第 0 级或记为 L0。这里我们展示的是三层高速缓存 L1 到 L3，占据存储器层次结构的第 1 层到第 3 层。主存在第 4 层

![](image/一个存储器层次结构.png)

可以利用对整个存储器层次结构的理解来提高程序性能

## 4、操作系统管理硬件

所有应用程序对硬件的操作尝试都必须通过操作系统。操作系统有两个基本功能∶
- （1）防止硬件被失控的应用程序滥用；
- （2）向应用程序提供简单一致的机制来控制复杂而又通常大不相同的低级硬件设备。

操作系统通过几个基本的抽象概念（进程、虚拟内存和文件）来实现这两个功能

![](image/操作系统提供的抽象表示.png)

### 4.1、进程

进程是操作系统对一个正在运行的程序的一种抽象。在一个系统上可以同时运行多个进程，而每个进程都好像在独占地使用硬件；并发运行，则是说一个进程的指令和另一个进程的指令是交错执行的；先进的多核处理器同时能够执行多个程序；

无论是在单核还是多核系统中，一个 CPU 看上去都像是在并发地执行多个进程，这是通过处理器在进程间切换来实现的。操作系统实现这种交错执行的机制称为上下文切换

**上下文** 操作系统保持跟踪进程运行所需的所有状态信息。这种状态，也就是上下文，包括许多信息，比如 PC 和寄存器文件的当前值，以及主存的内容；在任何一个时刻，单处理器系统都只能执行一个进程的代码。当操作系统决定要把控制权从当前进程转移到某个新进程时，就会进行上下文切换，即保存当前进程的上下文、恢复新进程的上下文，然后将控制权传递到新进程

从一个进程到另一个进程的转换是由操作系统**内核**（kernel）管理的。内核是操作系统代码常驻主存的部分。当应用程序需要操作系统的某些操作时，比如读写文件，它就执行一条特殊的系统调用（system call）指令，将控制权传递给内核。然后内核执行被请求的操作并返回应用程序。注意，内核不是一个独立的进程。相反，它是系统管理全部进程所用代码和数据结构的集合

![](image/进程上下文切换.png)

### 4.2、线程

一个进程实际上可以由多个称为线程的执行单元组成，每个线程都运行在进程的上下文中，并共享同样的代码和全局数据；

多线程之间比多进程之间更容易共享数据，也因为线程一般来说都比进程更高效。当有多处理器可用的时候，多线程也是一种使得程序可以运行得更快的方法

### 4.3、虚拟内存

虚拟内存是一个抽象概念，它为每个进程提供了一个假象，即每个进程都在独占地使用主存。每个进程看到的内存都是一致的，称为虚拟地址空间；在 Linux 中，地址空间最上面的区域是保留给操作系统中的代码和数据的，这对所有进程来说都是一样。地址空间的底部区域存放用户进程定义的代码和数据。请注意，图中的地址是从下往上增大的

![](image/进程的虚拟地址空间.png)

每个进程看到的虚拟地址空间由大量准确定义的区构成，每个区都有专门的功能
- 程序代码和数据：对所有的进程来说，代码是从同一固定地址开始，紧接着的是和 C 全局变量相对应的数据位置；
- 堆：代码和数据区后紧随着的是运行时堆。代码和数据区在进程一开始运行时就被指定了大小，与此不同，当调用像 malloc 和 free 这样的 C 标准库函数时，堆可以在运行时动态地扩展和收缩；
- 共享库：大约在地址空间的中间部分是一块用来存放像 C 标准库和数学库这样的共享库的代码和数据的区域；
- 栈：位于用户虚拟地址空间顶部的是用户栈，编译器用它来实现函数调用。和堆一样，用户栈在程序执行期间可以动态地扩展和收缩。特别地，每次我们调用一个函数时，栈就会增长；从一个函数返回时，栈就会收缩；
- 内核虚拟内存：地址空间顶部的区域是为内核保留的。不允许应用程序读写这个区域的内容或者直接调用内核代码定义的函数。相反，它们必须调用内核来执行这些操作；
- 文件：文件就是字节序列，仅此而已。每个I/O设备，包括磁盘、键盘、显示器，甚至网络，都可以看成是文件。系统中的所有输入输出都是通过使用一小组称为 Unix I/O 的系统函数调用读写文件来实现

## 5、其他

### 5.1、Amdahl 定律

### 5.2、并发和并行

- 并发（concurrency）是一个通用的概念，指一个同时具有多个活动的系统；
- 并行（parallelism）指的是用并发来使一个系统运行得更快

系统层次结构中由高到低的顺序重点强调三个层次
- 线程级并发
- 指令级并行
- 单指令、多数据并行

## 6、系统抽象

![](image/计算机操作系统抽象.png)

- 文件是对 I/O 设备的抽象
- 虚拟内存是对程序存储器的抽象
- 进程是对一个正在运行的程序的抽象。
- 虚拟机，它提供对整个计算机的抽象，包括操作系统、处理器和程序
- 在处理器里，指令集架构提供了对实际处理器硬件的抽象

# 二、信息的表示与处理

## 1、信息存储

大多数计算机使用 8 位的块，或者**字节（byte）**，作为最小的可寻址的内存单位，而不是访问内存中单独的位；

机器级程序将内存视为一个非常大的字节数组，称为**虚拟内存（virtual memory）**，内存的每个字节都由一个唯一的数字来标识，称为它的**地址（address）**，所有可能地址的集合就称为**虚拟地址空间（virtual address space）**


# 其他

操作系统这门课程，讲的就是这个计算机的大管家，是如何管理程序的运行，以及如何管理计算机硬件资源并提供接口给程序使用的一门计算机基础课程！

操作系统的核心是：
- 管理程序运行：线程管理、进程管理
- 管理内存资源：内存管理
- 管理硬盘资源：文件系统
- 管理网卡资源：网络协议栈；
- 管理输入输出：中断管理、同步与异步
- 为应用程序提供接口：系统调用；

操作系统理论和具体的操作系统实现，这是两码事情！


- [南京大学 计算机科学与技术系 计算机系统基础 课程实验 2023](https://nju-projectn.github.io/ics-pa-gitbook/ics2023/)
- [CSAPP 深入理解计算机系统](https://www.bilibili.com/video/av31289365/)
- [互联网操作系统](https://github.com/HeyPuter/puter)
- [如何学习操作系统](https://mp.weixin.qq.com/s/Fp2ijjGH_qpuClQFOnVzGg)
