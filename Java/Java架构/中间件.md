<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
**目录**

- [一、消息中间件](#%E4%B8%80%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6)
- [二、ActiveMQ](#%E4%BA%8Cactivemq)
  - [1、ActiveMQ 基本概念](#1activemq-%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5)
  - [2、使用 ActiveMQ](#2%E4%BD%BF%E7%94%A8-activemq)
  - [3、ActiveMQ 集群](#3activemq-%E9%9B%86%E7%BE%A4)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# 一、消息中间件

MQ的衡量指标：服务性能、数据存储、集群架构
## 1、主流中间件介绍

### 1.1、ActiveMQ
- 概述：
	
### 1.2、Kafka

### 1.3、RocketMQ

### 1.4、RabbitMQ

## 2、AMQP协议-高级消息队列协议

### 2.1、概述
是具有现代特征的二进制协议，是一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计


### 2.2、AMQP协议模型

### 2.3、AMQP核心概念

- Server：又称Broker，接受客户端连接，实现AMQP实体服务；
- Connction：连接，应用程序与Broker的网络连接；
- Channel：网络信道，几乎所有的操作都是在Channel进行，Channel是进行消息读写的通道；客户端可以建立多个Channel，每个Channle代表一个会话任务；
- Message：消息，服务器和应用程序之间传输的数据，由Properties和body组成，Properties对消息进行修饰，比如消息的优先级、延迟等；Body则是消息体内容；
- Virtual Host：虚拟地址，用户进行逻辑隔离，最上层的消息路由；一个Virtual Host里面可以有若干个Exchange和Q，同一个Virtual Host里面不能有相同名称的Exchange或Queue；
- Exchange：交换机，接受消息，根据路由键转发消息到绑定的队列；
- Binding：Exchange和Queue之间的虚拟连接，binding中可以包含routing key；
- Routing Key：一个路由规则，虚拟机可用它来确定如何路由一个特点消息；
- Queue：也称为Message Queue，消息队列，保存消息并将它们转发给消费者；

# 二、RabbitMQ

## 1、概述

### 1.1、定义：
RabbitMQ是一个开源的消息代理和队列服务器器，RabbitMQ是使用Erlang语言来编写的，并且RabbitMQ是AMQP协议；

### 1.2、具有以下特点：
- 开源、性能优秀，稳定性保障；
- 提供可靠性消息投递模式、返回模式；
- 与SpringAMQP完美整合，API丰富；
- 集群模式丰富，表达式配置，HA模式，镜像对象模型；
- 保障数据不丢失的前提做到高可靠性、可用性

### 1.3、高性能原因
- Erlang语言最初在于交换机领域的架构模式，使得RabbitMQ在broker之间进行数据交互性能是非常优秀的；
- Erlang特点：有着和原生socket一样的延迟；

### 1.4、RabbitMQ的整体架构


### 1.5、RabbitMQ消息流转

## 2、RabbitMQ命令与控制台

## 3、Exchange交换机
接收消息，并根据路由键转发消息所绑定的队列

### 3.1、属性
- Name：交换名称
- Type：交换机类型direct、topic、fanout、headers；
- Durability：是否需要持久化，true为持久化；
- Auto Delete：当最后一个绑定到Exchange上队列删除后，自动删除该Exchange；
- Iternal：当前exchange是否用于RabbitMQ内部使用，默认为false；
- Arguments：扩展参数，用于扩展AMQP协议自制定化使用

### 3.2、交换机类型
- Direct Exchange

  所有发生到Direct Exchange的消息被转到到RoutingKey中指定的Queue；

  *注意：*Driect模式可以使用RabbitMQ自带的Exchange：default Exchange，所以不需要讲Exchange进行任何绑定操作，消息传递时，RouteKey必须完全匹配才会被队列接受，否则该消息会被抛弃；

- Topic Exchange

  所有发送到Topic Exchange的消息被转发到所有关心RouteKey中指定的Topic的Queue上；Exchange将RouteKey和某Topic进行模糊匹配，此时队列需要绑定一个Topic；
  
  可以使用通配符进行模糊匹配。模糊匹配规则：

  - “#” 匹配一个或多个词，“log.#” 能匹配到log.info.oa
  - “*” 匹配到不多不少一个词，“log.*” 只会匹配到 log.eorror

- Fanout Exchange

  不处理路由键，只需要简单的将队列绑定到交换机上；发送到交换机的消息都会被转发到与该交换机绑定的所有队列上，Fanout交换机转发消息是最快的

## 4、其他概念
- Binding-绑定
  - Exchange和Exchange、Queue之间的连接关系
  - Binding中可以包含RoutingKey或者参数；

- Queue-消息队列
  - 消息队列，实际存储消息数据
  - Durability：是否持久化，Durable：是，Transient：否
  - Auto Delete：如选yes，代表当最后一个监听被移除之后，该Queue不会自动被删除；

- Message-消息
  - 服务器和应用程序指定件传送的数据
  - 本质上是一段数据，有Properties何Payload（Body）组成
  - 常用属性：delivery mode、headers（自定义属性）
  - content_type, content_encoding, priority
  - correlation_id, reply_to, expiration, message_id
  - timestamp, type, user_id, app_id, cluster_id

- Virtual host-虚拟主机
  - 虚拟地址，用于进行逻辑隔离，最上层的消息路由；

## 5、消息如何保障100%投递成功

### 5.1、生产端的可靠性消息投递

- 如何保障消息可靠性投递
  - 保障消息成功发出；
  - 保障MQ节点的成功接收
  - 发送端收到 MQ节点（Broker）确认应答
  - 完善的消息进行补偿机制

- 生产端可靠性投递解决方案

  - 消息落库，对消息进行状态打标；在高并发场景下，可能存在大量的数据库操作
  - 消息的延迟投递，做二次确认，回调检查，回调检查是补偿机制

    ![image](https://github.com/chenlanqing/learningNote/blob/master/Java/Java%E6%9E%B6%E6%9E%84/image/中间件/生产端可靠性消息投递-二次确认.png)

### 5.2、消费端幂等性保障

*在海量订单产生的业务高峰期，如何避免消息的重复消费问题*

消费端实现幂等性，意味着消息永远不可能被消费多次，即使收到了多条一样的消息

消费端幂等性解决方案：
- 唯一ID + 指纹码机制，利用数据库主键去重；
  - 实现简单；
  - 高并发下有数据库写入的性能瓶颈；
  - 解决方案：跟进ID进行分库分表进行算法路由

- 利用redis的原子性实现

  需要注意的问题：
  - 是否需要对数据进行落库，如果落库的话，关键解决的问题是数据库和缓存如何做到原子性；
  - 如果不进行落库，那么都存到缓存中，如何设置定时同步策略；

## 6、Confirm确认消息
### 6.1、概述
- 消息的确认，是指生产者投递消息后，如果broker收到消息，则会给生产者一个应答；
- 生产者进行接收应答，用来确定这条消息是否正常的发送到Broker，这种方式也是消息的可靠性投递的核心保障；

### 6.2、如何实现Confirm确认消息
- （1）在channel上开启确认模式：channel.confirmSelect();
- （2）在channel上添加监听：addConfirmListner，监听成功和失败的返回结果，根据具体的结果对消息进行重新发送，或记录日志等待后续处理；

# 参考资料
* [RabbitMQ官方文档](http://www.rabbitmq.com/documentation.html)
* [RabbitMQ命令操作](https://blog.csdn.net/noonebirdyou/article/details/54645755)